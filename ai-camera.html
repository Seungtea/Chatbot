<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 카메라 사물 인식</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f7f9fb;
        }

        .container { max-width: 800px; }

        #video-feed {
            width: 100%;
            height: auto;
            min-height: 200px;
            background-color: #1f2937;
            border-radius: 12px;
            object-fit: cover;
            transform: scaleX(-1);
            display: none;
        }

        .ai-status-box {
            padding: 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            background-color: #1f2937;
            border-radius: 12px;
            color: #9ca3af;
        }

        .api-key-section {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .api-key-input {
            font-family: monospace;
        }

        .recognition-history {
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            font-size: 0.875rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .history-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

<div id="app" class="container mx-auto p-6 bg-white shadow-xl rounded-xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">AI 카메라 사물 인식기</h1>
    <p class="text-center text-gray-600 mb-6">카메라로 물체를 비추면 AI가 인식합니다. 음성 명령도 지원합니다.</p>

    <!-- API 키 설정 -->
    <div id="api-key-section" class="api-key-section mb-4">
        <div class="flex items-center justify-between mb-2">
            <label for="api-key-input" class="font-semibold text-gray-700">Gemini API 키</label>
            <button id="toggle-api-key" class="text-sm text-indigo-600 hover:text-indigo-800" onclick="app.toggleApiKeyVisibility()">
                보기/숨기기
            </button>
        </div>
        <div class="flex gap-2">
            <input
                type="password"
                id="api-key-input"
                class="api-key-input flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="API 키를 입력하세요"
                aria-label="Gemini API 키 입력"
            >
            <button
                id="save-api-key"
                class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
                onclick="app.saveApiKey()"
            >
                저장
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">API 키는 브라우저에 안전하게 저장됩니다.</p>
    </div>

    <!-- AI 상태 및 결과 표시 -->
    <div id="ai-response" class="ai-status-box mb-4 text-center bg-blue-100 text-blue-700" role="status" aria-live="polite">
        <span id="status-message">준비 완료. 시작 버튼을 눌러주세요.</span>
    </div>

    <!-- 비디오 피드 -->
    <div class="mb-6 relative">
        <div id="video-placeholder" class="video-placeholder">
            <span>카메라가 여기에 표시됩니다</span>
        </div>
        <video id="video-feed" autoplay playsinline aria-label="카메라 피드"></video>
        <canvas id="canvas" style="display: none;" aria-hidden="true"></canvas>
    </div>

    <!-- 컨트롤 버튼 -->
    <div class="flex flex-col space-y-3">
        <button
            id="start-button"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
            onclick="app.startConversation()"
            aria-label="AI 대화 시작"
        >
            AI 대화 시작 (클릭)
        </button>
        <button
            id="stop-recognition-button"
            class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 shadow-md"
            style="display: none;"
            onclick="app.stopRecognition()"
            aria-label="사물 인식 중지"
        >
            사물 인식 및 카메라 끄기
        </button>
    </div>

    <!-- 인식 결과 출력 -->
    <div class="mt-8">
        <h2 class="text-2xl font-semibold text-gray-700 text-center mb-4">현재 인식된 사물</h2>
        <div id="object-result" class="text-5xl font-extrabold text-center py-6 text-indigo-600 bg-indigo-50 rounded-lg shadow-inner" aria-live="polite">
            -
        </div>
    </div>

    <!-- 인식 기록 -->
    <div class="mt-6">
        <h3 class="text-lg font-semibold text-gray-600 mb-2">최근 인식 기록</h3>
        <div id="recognition-history" class="recognition-history bg-gray-50 rounded-lg p-3">
            <p class="text-gray-400 text-sm">아직 인식 기록이 없습니다.</p>
        </div>
    </div>
</div>

<script>
// 상수 정의
const CONFIG = {
    MODEL_NAME: 'gemini-2.5-flash-preview-05-20',
    RECOGNITION_INTERVAL: 2500,
    RETRY_INTERVAL: 5000,
    SPEECH_START_DELAY: 1500,
    MAX_HISTORY: 10,
    STORAGE_KEYS: {
        API_KEY: 'gemini_api_key'
    }
};

// 상태 타입 정의
const STATUS_TYPES = {
    INFO: 'info',
    WAIT: 'wait',
    SUCCESS: 'success',
    ERROR: 'error'
};

/**
 * AI 카메라 사물 인식 애플리케이션 클래스
 */
class AICameraApp {
    constructor() {
        // DOM 요소
        this.elements = {
            video: document.getElementById('video-feed'),
            canvas: document.getElementById('canvas'),
            statusMessage: document.getElementById('status-message'),
            objectResult: document.getElementById('object-result'),
            startButton: document.getElementById('start-button'),
            stopButton: document.getElementById('stop-recognition-button'),
            videoPlaceholder: document.getElementById('video-placeholder'),
            apiKeyInput: document.getElementById('api-key-input'),
            historyContainer: document.getElementById('recognition-history')
        };

        // 상태 변수
        this.state = {
            recognitionInterval: null,
            isRecognitionActive: false,
            isAwaitingCommand: false,
            apiKey: '',
            recognitionHistory: [],
            voicesLoaded: false
        };

        // Web Speech API 초기화
        this.initSpeechAPI();

        // 저장된 API 키 로드
        this.loadApiKey();
    }

    /**
     * Web Speech API 초기화
     */
    initSpeechAPI() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.synthesis = window.speechSynthesis;

        if (SpeechRecognition) {
            this.recognition = new SpeechRecognition();
            this.recognition.lang = 'ko-KR';
            this.recognition.interimResults = false;
            this.recognition.maxAlternatives = 1;
            this.setupRecognitionHandlers();
        } else {
            this.updateStatus('경고: 이 브라우저에서는 음성 인식을 지원하지 않습니다.', STATUS_TYPES.ERROR);
            this.elements.startButton.textContent = 'AI 대화 시작 (음성 인식 불가)';
        }

        // 음성 목록 로드 대기
        if (this.synthesis) {
            if (this.synthesis.getVoices().length > 0) {
                this.state.voicesLoaded = true;
            } else {
                this.synthesis.addEventListener('voiceschanged', () => {
                    this.state.voicesLoaded = true;
                });
            }
        }
    }

    /**
     * 음성 인식 이벤트 핸들러 설정
     */
    setupRecognitionHandlers() {
        this.recognition.onresult = (event) => {
            if (!this.state.isAwaitingCommand) return;

            const transcript = event.results[0][0].transcript.trim();
            console.log('사용자 발화:', transcript);
            this.handleVoiceCommand(transcript);
        };

        this.recognition.onend = () => {
            if (this.state.isAwaitingCommand) {
                this.recognition.start();
                this.updateStatus('AI: 명령 대기 중...', STATUS_TYPES.WAIT);
            }
        };

        this.recognition.onerror = (event) => {
            console.error('음성 인식 오류:', event.error);

            if (event.error === 'no-speech') {
                this.updateStatus('음성이 감지되지 않았습니다. 다시 말씀해주세요.', STATUS_TYPES.WAIT);
            } else if (event.error === 'not-allowed') {
                this.updateStatus('마이크 권한이 필요합니다. 브라우저 설정을 확인해주세요.', STATUS_TYPES.ERROR);
                this.state.isAwaitingCommand = false;
                return;
            } else {
                this.updateStatus(`음성 인식 오류: ${event.error}`, STATUS_TYPES.ERROR);
            }

            if (this.state.isAwaitingCommand) {
                setTimeout(() => this.recognition.start(), 1000);
            }
        };
    }

    /**
     * 음성 명령 처리
     */
    handleVoiceCommand(transcript) {
        const lowerTranscript = transcript.toLowerCase();

        if (lowerTranscript.includes('응') || lowerTranscript.includes('시작해줘') || lowerTranscript.includes('시작')) {
            this.state.isAwaitingCommand = false;
            this.startRecognition();
        } else if (lowerTranscript.includes('아니') || lowerTranscript.includes('괜찮아') || lowerTranscript.includes('종료')) {
            this.state.isAwaitingCommand = false;
            this.speak('알겠습니다. 종료합니다.');
            this.updateStatus('사용자 요청으로 대화 종료.', STATUS_TYPES.INFO);
        } else if ((lowerTranscript.includes('카메라') && lowerTranscript.includes('꺼')) ||
                   lowerTranscript.includes('인식 종료')) {
            if (this.state.isRecognitionActive) {
                this.speak('사물 인식을 중단합니다.');
                this.stopRecognition();
            }
        } else {
            this.speak('명령을 이해하지 못했습니다. 다시 시도해 주세요.');
            if (this.state.isAwaitingCommand) {
                this.recognition.start();
            }
        }
    }

    /**
     * API 키 저장
     */
    saveApiKey() {
        const apiKey = this.elements.apiKeyInput.value.trim();
        if (!apiKey) {
            alert('API 키를 입력해주세요.');
            return;
        }

        this.state.apiKey = apiKey;
        localStorage.setItem(CONFIG.STORAGE_KEYS.API_KEY, apiKey);
        this.updateStatus('API 키가 저장되었습니다.', STATUS_TYPES.SUCCESS);

        setTimeout(() => {
            this.updateStatus('준비 완료. 시작 버튼을 눌러주세요.', STATUS_TYPES.INFO);
        }, 2000);
    }

    /**
     * 저장된 API 키 로드
     */
    loadApiKey() {
        const savedKey = localStorage.getItem(CONFIG.STORAGE_KEYS.API_KEY);
        if (savedKey) {
            this.state.apiKey = savedKey;
            this.elements.apiKeyInput.value = savedKey;
        }
    }

    /**
     * API 키 표시/숨기기 토글
     */
    toggleApiKeyVisibility() {
        const input = this.elements.apiKeyInput;
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    /**
     * 텍스트를 음성으로 출력
     */
    speak(text) {
        if (!this.synthesis) {
            console.error('Speech Synthesis API를 지원하지 않습니다.');
            return;
        }

        // 이전 발화 취소
        this.synthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;

        // 한국어 음성 선택
        const voices = this.synthesis.getVoices();
        const koreanVoice = voices.find(voice =>
            voice.lang.includes('ko') && voice.name.includes('Female')
        ) || voices.find(voice => voice.lang.includes('ko'));

        if (koreanVoice) {
            utterance.voice = koreanVoice;
        }

        this.synthesis.speak(utterance);
    }

    /**
     * 상태 메시지 업데이트
     */
    updateStatus(message, type = STATUS_TYPES.INFO) {
        this.elements.statusMessage.textContent = message;
        const box = document.getElementById('ai-response');

        // 기본 클래스 초기화
        box.className = 'ai-status-box mb-4 text-center transition-all duration-300';

        const statusStyles = {
            [STATUS_TYPES.WAIT]: ['bg-yellow-100', 'text-yellow-700', 'pulse-animation'],
            [STATUS_TYPES.SUCCESS]: ['bg-green-100', 'text-green-700'],
            [STATUS_TYPES.ERROR]: ['bg-red-100', 'text-red-700'],
            [STATUS_TYPES.INFO]: ['bg-blue-100', 'text-blue-700']
        };

        box.classList.add(...(statusStyles[type] || statusStyles[STATUS_TYPES.INFO]));
    }

    /**
     * 카메라 시작
     */
    async startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });

            this.elements.video.srcObject = stream;
            this.elements.video.style.display = 'block';
            this.elements.videoPlaceholder.style.display = 'none';

            await new Promise(resolve => {
                this.elements.video.onloadedmetadata = resolve;
            });

            // 캔버스 크기 설정
            this.elements.canvas.width = this.elements.video.videoWidth;
            this.elements.canvas.height = this.elements.video.videoHeight;

            return true;
        } catch (error) {
            console.error('카메라 접근 오류:', error);

            let errorMessage = '카메라 접근에 실패했습니다.';
            if (error.name === 'NotAllowedError') {
                errorMessage = '카메라 권한이 거부되었습니다. 브라우저 설정에서 권한을 허용해주세요.';
            } else if (error.name === 'NotFoundError') {
                errorMessage = '카메라를 찾을 수 없습니다. 카메라가 연결되어 있는지 확인해주세요.';
            }

            this.updateStatus(errorMessage, STATUS_TYPES.ERROR);
            return false;
        }
    }

    /**
     * 카메라 중지
     */
    stopCamera() {
        if (this.elements.video.srcObject) {
            this.elements.video.srcObject.getTracks().forEach(track => track.stop());
            this.elements.video.srcObject = null;
        }
        this.elements.video.style.display = 'none';
        this.elements.videoPlaceholder.style.display = 'flex';
    }

    /**
     * 사물 인식 시작
     */
    async startRecognition() {
        if (this.state.isRecognitionActive) return;

        // API 키 확인
        if (!this.state.apiKey) {
            this.updateStatus('API 키를 먼저 입력해주세요.', STATUS_TYPES.ERROR);
            this.speak('API 키를 먼저 입력해주세요.');
            return;
        }

        const cameraStarted = await this.startCamera();
        if (!cameraStarted) {
            this.stopRecognition();
            return;
        }

        this.state.isRecognitionActive = true;
        this.elements.startButton.style.display = 'none';
        this.elements.stopButton.style.display = 'block';
        this.elements.objectResult.innerHTML = '<span class="spinner"></span>분석 중...';
        this.updateStatus('카메라를 켜고 물체를 분석합니다.', STATUS_TYPES.SUCCESS);

        // 인식 루프 시작
        this.state.recognitionInterval = setInterval(() => {
            this.runObjectRecognition();
        }, CONFIG.RECOGNITION_INTERVAL);
    }

    /**
     * 사물 인식 중지
     */
    stopRecognition() {
        clearInterval(this.state.recognitionInterval);
        this.stopCamera();
        this.state.isRecognitionActive = false;
        this.state.isAwaitingCommand = false;

        this.elements.startButton.style.display = 'block';
        this.elements.stopButton.style.display = 'none';
        this.elements.objectResult.textContent = '-';
        this.updateStatus('사물 인식 종료. 다시 시작하려면 버튼을 누르세요.', STATUS_TYPES.INFO);
    }

    /**
     * 비디오 프레임 캡처
     */
    captureFrame() {
        const context = this.elements.canvas.getContext('2d');

        // 비디오 크기에 맞춰 캔버스 크기 조정
        this.elements.canvas.width = this.elements.video.videoWidth;
        this.elements.canvas.height = this.elements.video.videoHeight;

        // 거울 모드 반전 적용
        context.save();
        context.scale(-1, 1);
        context.drawImage(this.elements.video, 0, 0, -this.elements.canvas.width, this.elements.canvas.height);
        context.restore();

        return this.elements.canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
    }

    /**
     * 인식 기록 추가
     */
    addToHistory(item) {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        this.state.recognitionHistory.unshift({ item, timestamp });

        // 최대 기록 수 제한
        if (this.state.recognitionHistory.length > CONFIG.MAX_HISTORY) {
            this.state.recognitionHistory.pop();
        }

        this.renderHistory();
    }

    /**
     * 인식 기록 렌더링
     */
    renderHistory() {
        if (this.state.recognitionHistory.length === 0) {
            this.elements.historyContainer.innerHTML = '<p class="text-gray-400 text-sm">아직 인식 기록이 없습니다.</p>';
            return;
        }

        const historyHtml = this.state.recognitionHistory
            .map(entry => `<div class="history-item"><span class="text-gray-500">${entry.timestamp}</span> - <span class="font-medium">${entry.item}</span></div>`)
            .join('');

        this.elements.historyContainer.innerHTML = historyHtml;
    }

    /**
     * Gemini API 호출하여 사물 인식 수행
     */
    async runObjectRecognition() {
        if (!this.state.isRecognitionActive) return;

        const base64Image = this.captureFrame();
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODEL_NAME}:generateContent?key=${this.state.apiKey}`;

        const prompt = '카메라에 보이는 물건이 무엇인지 한국어로 가장 깔끔하게 한 단어로만 답해주세요. 예를 들어, "필통", "핸드폰", "약"과 같이 명사 하나로만 답하세요. 추가 설명은 절대 하지 마세요.';

        const payload = {
            contents: [{
                role: 'user',
                parts: [
                    { text: prompt },
                    {
                        inlineData: {
                            mimeType: 'image/jpeg',
                            data: base64Image
                        }
                    }
                ]
            }],
            generationConfig: {
                temperature: 0.1,
                maxOutputTokens: 50
            }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP ${response.status}`);
            }

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

            if (!text) {
                throw new Error('응답에서 텍스트를 찾을 수 없습니다.');
            }

            // 결과 표시
            this.elements.objectResult.textContent = text;
            this.updateStatus(`사물 인식 중: ${text}`, STATUS_TYPES.WAIT);
            this.addToHistory(text);

        } catch (error) {
            console.error('Gemini API 호출 오류:', error);

            let errorMessage = 'API 오류 발생';
            if (error.message.includes('API_KEY')) {
                errorMessage = 'API 키가 유효하지 않습니다.';
                this.stopRecognition();
            } else if (error.message.includes('quota')) {
                errorMessage = 'API 사용량 한도 초과';
            }

            this.elements.objectResult.textContent = errorMessage;
            this.updateStatus(`오류: ${error.message}`, STATUS_TYPES.ERROR);

            // 오류 발생 시 간격 늘리기
            clearInterval(this.state.recognitionInterval);
            this.state.recognitionInterval = setInterval(() => {
                this.runObjectRecognition();
            }, CONFIG.RETRY_INTERVAL);
        }
    }

    /**
     * AI 대화 시작
     */
    startConversation() {
        if (!this.recognition) {
            this.updateStatus('음성 인식 API를 지원하지 않아 기능을 실행할 수 없습니다.', STATUS_TYPES.ERROR);
            return;
        }

        if (!this.state.apiKey) {
            this.updateStatus('API 키를 먼저 입력해주세요.', STATUS_TYPES.ERROR);
            alert('Gemini API 키를 먼저 입력해주세요.');
            this.elements.apiKeyInput.focus();
            return;
        }

        if (this.state.isRecognitionActive) {
            this.speak('이미 사물 인식이 진행 중입니다.');
            return;
        }

        this.state.isAwaitingCommand = true;
        this.updateStatus('AI: 명령 대기 중...', STATUS_TYPES.WAIT);

        this.speak('사물 인식을 시작할까요?');

        // AI가 말을 마친 후 음성 인식 시작
        setTimeout(() => {
            this.recognition.start();
        }, CONFIG.SPEECH_START_DELAY);
    }
}

// 앱 인스턴스 생성 및 전역 등록
const app = new AICameraApp();
</script>
</body>
</html>
